# ä»£ç†æ¨¡å¼å¯¹æ¯”è¯´æ˜ - ä½¿ç”¨å‰åå·®å¼‚åˆ†æ

## ç›®å½•
1. [å‰ç«¯åœºæ™¯è¯¦è§£ï¼ˆé¢å‘åç«¯å¼€å‘è€…ï¼‰](#å‰ç«¯åœºæ™¯è¯¦è§£)
2. [åç«¯åœºæ™¯å¯¹æ¯”](#åç«¯åœºæ™¯å¯¹æ¯”)
3. [å®é™…ä»·å€¼åˆ†æ](#å®é™…ä»·å€¼åˆ†æ)

---

## å‰ç«¯åœºæ™¯è¯¦è§£

### åœºæ™¯1ï¸âƒ£ï¼šè¡¨å•æ•°æ®éªŒè¯

#### âŒ ä¸ä½¿ç”¨ä»£ç†çš„ä¼ ç»Ÿæ–¹å¼

```javascript
// ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦åœ¨æ¯ä¸ªåœ°æ–¹æ‰‹åŠ¨è°ƒç”¨éªŒè¯
class UserForm {
  constructor() {
    this.data = {
      name: '',
      age: 0,
      email: ''
    };
  }

  // é—®é¢˜1ï¼šæ¯æ¬¡è®¾ç½®æ•°æ®éƒ½è¦è®°å¾—æ‰‹åŠ¨è°ƒç”¨éªŒè¯
  setName(value) {
    // æ‰‹åŠ¨éªŒè¯é€»è¾‘
    if (value.length < 3) {
      this.showError('name', 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦');
      return false;
    }
    this.data.name = value;
    this.updateUI('name');
    return true;
  }

  setAge(value) {
    // é‡å¤çš„éªŒè¯é€»è¾‘
    if (value < 0 || value > 150) {
      this.showError('age', 'å¹´é¾„å¿…é¡»åœ¨0-150ä¹‹é—´');
      return false;
    }
    this.data.age = value;
    this.updateUI('age');
    return true;
  }

  setEmail(value) {
    // åˆæ˜¯é‡å¤çš„æ¨¡å¼
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) {
      this.showError('email', 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
      return false;
    }
    this.data.email = value;
    this.updateUI('email');
    return true;
  }

  showError(field, message) {
    document.getElementById(`${field}Error`).textContent = message;
  }

  updateUI(field) {
    document.getElementById(field).value = this.data[field];
  }
}

// ä½¿ç”¨æ—¶éå¸¸ç¹ç
const form = new UserForm();

// æ¯ä¸ªè¾“å…¥æ¡†éƒ½è¦ç»‘å®šäº‹ä»¶
document.getElementById('name').addEventListener('input', (e) => {
  if (!form.setName(e.target.value)) {
    // éªŒè¯å¤±è´¥ï¼Œéœ€è¦é¢å¤–å¤„ç†
  }
});

document.getElementById('age').addEventListener('input', (e) => {
  if (!form.setAge(e.target.value)) {
    // éªŒè¯å¤±è´¥ï¼Œéœ€è¦é¢å¤–å¤„ç†
  }
});

// ... æ¯ä¸ªå­—æ®µéƒ½è¦é‡å¤è¿™ä¸ªæ¨¡å¼
```

**é—®é¢˜æ€»ç»“ï¼š**
1. âŒ æ¯ä¸ªå­—æ®µéƒ½éœ€è¦å†™ä¸€ä¸ªsetteræ–¹æ³•
2. âŒ éªŒè¯é€»è¾‘åˆ†æ•£ï¼Œéš¾ä»¥ç»´æŠ¤
3. âŒ æ–°å¢å­—æ®µæ—¶ä»£ç é‡å¤§å¢
4. âŒ å®¹æ˜“å¿˜è®°è°ƒç”¨éªŒè¯
5. âŒ ä»£ç é‡å¤ï¼ˆéªŒè¯â†’æ›´æ–°UIâ†’æ˜¾ç¤ºé”™è¯¯ï¼‰

---

#### âœ… ä½¿ç”¨ä»£ç†çš„ä¼˜é›…æ–¹å¼

```javascript
// ä½¿ç”¨Proxyï¼šè‡ªåŠ¨æ‹¦æˆªæ‰€æœ‰èµ‹å€¼æ“ä½œ
class UserForm {
  constructor() {
    // éªŒè¯è§„åˆ™é…ç½®
    this.rules = {
      name: {
        validate: (value) => {
          if (value.length < 3) return 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦';
          return null; // nullè¡¨ç¤ºé€šè¿‡
        }
      },
      age: {
        validate: (value) => {
          if (value < 0 || value > 150) return 'å¹´é¾„å¿…é¡»åœ¨0-150ä¹‹é—´';
          return null;
        }
      },
      email: {
        validate: (value) => {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) return 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
          return null;
        }
      }
    };

    // åˆ›å»ºä»£ç†å¯¹è±¡
    this.data = new Proxy({
      name: '',
      age: 0,
      email: ''
    }, {
      set: (target, property, value) => {
        // ç»Ÿä¸€çš„éªŒè¯é€»è¾‘
        if (this.rules[property]) {
          const error = this.rules[property].validate(value);
          if (error) {
            this.showError(property, error);
            throw new Error(error); // é˜»æ­¢èµ‹å€¼
          }
          this.clearError(property);
        }

        // èµ‹å€¼
        target[property] = value;

        // è‡ªåŠ¨æ›´æ–°UI
        this.updateUI(property);

        console.log(`âœ… ${property} éªŒè¯é€šè¿‡: ${value}`);
        return true;
      },

      get: (target, property) => {
        console.log(`ğŸ“– è¯»å– ${property}: ${target[property]}`);
        return target[property];
      }
    });
  }

  showError(field, message) {
    document.getElementById(`${field}Error`).textContent = message;
  }

  clearError(field) {
    document.getElementById(`${field}Error`).textContent = '';
  }

  updateUI(field) {
    // è‡ªåŠ¨æ›´æ–°ç›¸å…³UI
  }
}

// ä½¿ç”¨æ—¶éå¸¸ç®€å•
const form = new UserForm();

// ç›´æ¥èµ‹å€¼å³å¯ï¼Œä»£ç†è‡ªåŠ¨å¤„ç†éªŒè¯å’ŒUIæ›´æ–°
document.getElementById('name').addEventListener('input', (e) => {
  try {
    form.data.name = e.target.value; // è‡ªåŠ¨éªŒè¯ï¼
  } catch (error) {
    // éªŒè¯å¤±è´¥å·²ç»è‡ªåŠ¨æ˜¾ç¤ºé”™è¯¯
  }
});

// æ–°å¢å­—æ®µè¶…çº§ç®€å•ï¼Œåªéœ€æ·»åŠ éªŒè¯è§„åˆ™
form.rules.phone = {
  validate: (value) => {
    if (!/^1\d{10}$/.test(value)) return 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®';
    return null;
  }
};
```

**ä¼˜åŠ¿æ€»ç»“ï¼š**
1. âœ… ä¸éœ€è¦ä¸ºæ¯ä¸ªå­—æ®µå†™setter
2. âœ… éªŒè¯é€»è¾‘é›†ä¸­ç®¡ç†
3. âœ… æ–°å¢å­—æ®µåªéœ€é…ç½®è§„åˆ™
4. âœ… è‡ªåŠ¨æ‹¦æˆªæ‰€æœ‰èµ‹å€¼æ“ä½œ
5. âœ… ä»£ç ç®€æ´ï¼Œæ˜“äºç»´æŠ¤

**ç±»æ¯”åç«¯ç†è§£ï¼š**
è¿™å°±åƒSpring AOPä¸€æ ·ï¼Œä½ ä¸éœ€è¦åœ¨æ¯ä¸ªServiceæ–¹æ³•é‡Œæ‰‹åŠ¨å†™ï¼š
```java
// ä¸ç”¨è¿™æ ·
public void transfer() {
    beginTransaction();
    try {
        // ä¸šåŠ¡é€»è¾‘
        commit();
    } catch (Exception e) {
        rollback();
    }
}

// åªéœ€è¦åŠ æ³¨è§£
@Transactional
public void transfer() {
    // ä¸šåŠ¡é€»è¾‘
}
```

---

### åœºæ™¯2ï¸âƒ£ï¼šå“åº”å¼æ•°æ®ï¼ˆVue/Reactçš„æ ¸å¿ƒåŸç†ï¼‰

#### âŒ ä¸ä½¿ç”¨ä»£ç†çš„ä¼ ç»Ÿæ–¹å¼

```javascript
// ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨è¿½è¸ªæ•°æ®å˜åŒ–ï¼Œæ‰‹åŠ¨æ›´æ–°UI
class TodoApp {
  constructor() {
    this.todos = [];
    this.totalElement = document.getElementById('total');
    this.completedElement = document.getElementById('completed');
    this.listElement = document.getElementById('list');
  }

  // é—®é¢˜ï¼šæ¯æ¬¡ä¿®æ”¹æ•°æ®åï¼Œéƒ½è¦æ‰‹åŠ¨æ›´æ–°æ‰€æœ‰ç›¸å…³UI
  addTodo(text) {
    this.todos.push({ id: Date.now(), text, completed: false });

    // æ‰‹åŠ¨æ›´æ–°å¤šä¸ªåœ°æ–¹ï¼
    this.updateTotal();
    this.updateCompleted();
    this.renderList();
  }

  toggleTodo(id) {
    const todo = this.todos.find(t => t.id === id);
    if (todo) {
      todo.completed = !todo.completed;

      // åˆè¦æ‰‹åŠ¨æ›´æ–°ï¼
      this.updateCompleted();
      this.renderList();
    }
  }

  deleteTodo(id) {
    this.todos = this.todos.filter(t => t.id !== id);

    // è¿˜æ˜¯è¦æ‰‹åŠ¨æ›´æ–°ï¼
    this.updateTotal();
    this.updateCompleted();
    this.renderList();
  }

  // æ¯ä¸ªç»Ÿè®¡éƒ½è¦æ‰‹åŠ¨æ›´æ–°
  updateTotal() {
    this.totalElement.textContent = this.todos.length;
  }

  updateCompleted() {
    this.completedElement.textContent =
      this.todos.filter(t => t.completed).length;
  }

  renderList() {
    // æ‰‹åŠ¨æ¸²æŸ“åˆ—è¡¨
    this.listElement.innerHTML = this.todos.map(todo => `
      <li>${todo.text}</li>
    `).join('');
  }
}
```

**é—®é¢˜æ€»ç»“ï¼š**
1. âŒ æ¯æ¬¡ä¿®æ”¹æ•°æ®éƒ½è¦è®°å¾—æ›´æ–°UI
2. âŒ å®¹æ˜“é—æ¼æŸä¸ªUIæ›´æ–°
3. âŒ æ•°æ®å’ŒUIé«˜åº¦è€¦åˆ
4. âŒ éš¾ä»¥è¿½è¸ªå“ªäº›UIä¾èµ–å“ªäº›æ•°æ®
5. âŒ ä»£ç é‡å¤ä¸”éš¾ä»¥ç»´æŠ¤

---

#### âœ… ä½¿ç”¨ä»£ç†çš„å“åº”å¼æ–¹å¼ï¼ˆVue3åŸç†ï¼‰

```javascript
// ä½¿ç”¨Proxyï¼šè‡ªåŠ¨è¿½è¸ªä¾èµ–ï¼Œè‡ªåŠ¨æ›´æ–°UI
class ReactiveSystem {
  constructor() {
    this.effectStack = [];
    this.targetMap = new WeakMap();
  }

  // å“åº”å¼æ•°æ®
  reactive(target) {
    return new Proxy(target, {
      get: (obj, key) => {
        // è‡ªåŠ¨æ”¶é›†ä¾èµ–
        this.track(obj, key);
        return obj[key];
      },
      set: (obj, key, value) => {
        obj[key] = value;
        // è‡ªåŠ¨è§¦å‘æ›´æ–°
        this.trigger(obj, key);
        return true;
      }
    });
  }

  // ä¾èµ–æ”¶é›†
  track(target, key) {
    const effect = this.effectStack[this.effectStack.length - 1];
    if (!effect) return;

    let depsMap = this.targetMap.get(target);
    if (!depsMap) {
      this.targetMap.set(target, (depsMap = new Map()));
    }

    let dep = depsMap.get(key);
    if (!dep) {
      depsMap.set(key, (dep = new Set()));
    }
    dep.add(effect);
  }

  // è§¦å‘æ›´æ–°
  trigger(target, key) {
    const depsMap = this.targetMap.get(target);
    if (!depsMap) return;

    const dep = depsMap.get(key);
    if (dep) {
      dep.forEach(effect => effect());
    }
  }

  // å‰¯ä½œç”¨å‡½æ•°ï¼ˆè‡ªåŠ¨æ‰§è¡Œçš„å‡½æ•°ï¼‰
  effect(fn) {
    this.effectStack.push(fn);
    fn(); // é¦–æ¬¡æ‰§è¡Œï¼Œæ”¶é›†ä¾èµ–
    this.effectStack.pop();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const system = new ReactiveSystem();

// åˆ›å»ºå“åº”å¼æ•°æ®
const state = system.reactive({
  todos: [],
  count: 0
});

// å®šä¹‰å‰¯ä½œç”¨ï¼šå½“todoså˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°total
system.effect(() => {
  document.getElementById('total').textContent = state.todos.length;
  console.log('è‡ªåŠ¨æ›´æ–°total');
});

// å®šä¹‰å‰¯ä½œç”¨ï¼šå½“todoså˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°completed
system.effect(() => {
  const completed = state.todos.filter(t => t.completed).length;
  document.getElementById('completed').textContent = completed;
  console.log('è‡ªåŠ¨æ›´æ–°completed');
});

// å®šä¹‰å‰¯ä½œç”¨ï¼šå½“todoså˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ¸²æŸ“åˆ—è¡¨
system.effect(() => {
  const list = document.getElementById('list');
  list.innerHTML = state.todos.map(todo => `
    <li>${todo.text} - ${todo.completed ? 'å®Œæˆ' : 'æœªå®Œæˆ'}</li>
  `).join('');
  console.log('è‡ªåŠ¨æ¸²æŸ“åˆ—è¡¨');
});

// ğŸ‰ ç°åœ¨ä¿®æ”¹æ•°æ®ï¼ŒUIä¼šè‡ªåŠ¨æ›´æ–°ï¼
state.todos.push({ id: 1, text: 'å­¦ä¹ ä»£ç†æ¨¡å¼', completed: false });
// æ§åˆ¶å°è¾“å‡ºï¼š
// è‡ªåŠ¨æ›´æ–°total
// è‡ªåŠ¨æ›´æ–°completed
// è‡ªåŠ¨æ¸²æŸ“åˆ—è¡¨

state.todos[0].completed = true;
// æ§åˆ¶å°è¾“å‡ºï¼š
// è‡ªåŠ¨æ›´æ–°completed
// è‡ªåŠ¨æ¸²æŸ“åˆ—è¡¨
```

**ä¼˜åŠ¿æ€»ç»“ï¼š**
1. âœ… æ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘UIæ›´æ–°
2. âœ… è‡ªåŠ¨è¿½è¸ªä¾èµ–å…³ç³»
3. âœ… æ•°æ®å’ŒUIè§£è€¦
4. âœ… ä¸ä¼šé—æ¼UIæ›´æ–°
5. âœ… è¿™å°±æ˜¯Vue3ã€MobXçš„æ ¸å¿ƒåŸç†

**ç±»æ¯”åç«¯ç†è§£ï¼š**
è¿™å°±åƒæ•°æ®åº“çš„è§¦å‘å™¨ï¼ˆTriggerï¼‰ï¼š
```sql
-- ä½ ä¸éœ€è¦åœ¨æ¯æ¬¡æ’å…¥è®¢å•åæ‰‹åŠ¨æ›´æ–°åº“å­˜
INSERT INTO orders ...;
UPDATE inventory SET stock = stock - 1 ...;

-- åªéœ€è¦å®šä¹‰è§¦å‘å™¨
CREATE TRIGGER update_inventory
AFTER INSERT ON orders
FOR EACH ROW
BEGIN
  UPDATE inventory SET stock = stock - NEW.quantity;
END;

-- ä¹‹åæ’å…¥è®¢å•ï¼Œåº“å­˜è‡ªåŠ¨æ›´æ–°
INSERT INTO orders VALUES (...); -- åº“å­˜è‡ªåŠ¨å‡å°‘
```

---

### åœºæ™¯3ï¸âƒ£ï¼šAPIè¯·æ±‚ç¼“å­˜

#### âŒ ä¸ä½¿ç”¨ä»£ç†çš„ä¼ ç»Ÿæ–¹å¼

```javascript
// ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡è°ƒç”¨APIéƒ½è¦æ£€æŸ¥ç¼“å­˜
class ApiService {
  constructor() {
    this.cache = new Map();
  }

  // é—®é¢˜ï¼šæ¯ä¸ªAPIæ–¹æ³•éƒ½è¦é‡å¤ç¼“å­˜é€»è¾‘
  async getUser(id) {
    const cacheKey = `user_${id}`;

    // é‡å¤çš„ç¼“å­˜æ£€æŸ¥ä»£ç 
    if (this.cache.has(cacheKey)) {
      const cached = this.cache.get(cacheKey);
      if (Date.now() - cached.time < 60000) {
        console.log('ä»ç¼“å­˜è¯»å–');
        return cached.data;
      }
    }

    // å‘èµ·è¯·æ±‚
    console.log('ä»APIè·å–');
    const data = await fetch(`/api/users/${id}`).then(r => r.json());

    // ç¼“å­˜ç»“æœ
    this.cache.set(cacheKey, {
      data,
      time: Date.now()
    });

    return data;
  }

  async getPosts() {
    const cacheKey = 'posts';

    // åˆæ˜¯é‡å¤çš„ç¼“å­˜é€»è¾‘ï¼
    if (this.cache.has(cacheKey)) {
      const cached = this.cache.get(cacheKey);
      if (Date.now() - cached.time < 60000) {
        console.log('ä»ç¼“å­˜è¯»å–');
        return cached.data;
      }
    }

    console.log('ä»APIè·å–');
    const data = await fetch('/api/posts').then(r => r.json());

    this.cache.set(cacheKey, {
      data,
      time: Date.now()
    });

    return data;
  }

  // æ¯ä¸ªæ–¹æ³•éƒ½è¦é‡å¤è¿™ä¸ªæ¨¡å¼...
}

// ä½¿ç”¨
const api = new ApiService();
await api.getUser(1);  // APIè¯·æ±‚
await api.getUser(1);  // ç¼“å­˜è¯»å–
await api.getPosts();  // APIè¯·æ±‚
```

**é—®é¢˜æ€»ç»“ï¼š**
1. âŒ æ¯ä¸ªAPIæ–¹æ³•éƒ½è¦å†™ç¼“å­˜é€»è¾‘
2. âŒ ä»£ç é‡å¤ä¸¥é‡
3. âŒ ç¼“å­˜ç­–ç•¥ä¿®æ”¹æ—¶è¦æ”¹æ‰€æœ‰æ–¹æ³•
4. âŒ æ–°å¢APIæ—¶å®¹æ˜“å¿˜è®°åŠ ç¼“å­˜

---

#### âœ… ä½¿ç”¨ä»£ç†çš„ç»Ÿä¸€ç¼“å­˜æ–¹å¼

```javascript
// ä½¿ç”¨Proxyï¼šç»Ÿä¸€å¤„ç†æ‰€æœ‰APIçš„ç¼“å­˜
class ApiProxy {
  constructor(apiService, cacheTTL = 60000) {
    this.apiService = apiService;
    this.cache = new Map();
    this.cacheTTL = cacheTTL;

    // è¿”å›ä»£ç†å¯¹è±¡
    return new Proxy(apiService, {
      get: (target, property) => {
        const original = target[property];

        // åªä»£ç†æ–¹æ³•
        if (typeof original !== 'function') {
          return original;
        }

        // è¿”å›åŒ…è£…åçš„æ–¹æ³•
        return async (...args) => {
          const cacheKey = `${property}_${JSON.stringify(args)}`;

          // ç»Ÿä¸€çš„ç¼“å­˜é€»è¾‘
          if (this.cache.has(cacheKey)) {
            const cached = this.cache.get(cacheKey);
            if (Date.now() - cached.time < this.cacheTTL) {
              console.log(`âœ… ç¼“å­˜å‘½ä¸­: ${property}`);
              return cached.data;
            }
          }

          // è°ƒç”¨åŸå§‹æ–¹æ³•
          console.log(`ğŸ“¡ APIè¯·æ±‚: ${property}`);
          const data = await original.apply(target, args);

          // ç¼“å­˜ç»“æœ
          this.cache.set(cacheKey, {
            data,
            time: Date.now()
          });

          return data;
        };
      }
    });
  }
}

// åŸå§‹APIæœåŠ¡ï¼ˆä¸ç”¨å…³å¿ƒç¼“å­˜ï¼‰
class ApiService {
  async getUser(id) {
    return fetch(`/api/users/${id}`).then(r => r.json());
  }

  async getPosts() {
    return fetch('/api/posts').then(r => r.json());
  }

  async getComments(postId) {
    return fetch(`/api/posts/${postId}/comments`).then(r => r.json());
  }

  // æ–°å¢æ–¹æ³•æ— éœ€å†™ç¼“å­˜é€»è¾‘ï¼
  async getProfile(userId) {
    return fetch(`/api/profile/${userId}`).then(r => r.json());
  }
}

// ä½¿ç”¨ï¼šè‡ªåŠ¨ç¼“å­˜æ‰€æœ‰API
const api = new ApiProxy(new ApiService(), 60000);

await api.getUser(1);     // ğŸ“¡ APIè¯·æ±‚
await api.getUser(1);     // âœ… ç¼“å­˜å‘½ä¸­
await api.getPosts();     // ğŸ“¡ APIè¯·æ±‚
await api.getPosts();     // âœ… ç¼“å­˜å‘½ä¸­
await api.getProfile(1);  // ğŸ“¡ APIè¯·æ±‚ï¼ˆæ–°æ–¹æ³•è‡ªåŠ¨æ”¯æŒç¼“å­˜ï¼‰
```

**ä¼˜åŠ¿æ€»ç»“ï¼š**
1. âœ… ç¼“å­˜é€»è¾‘åªå†™ä¸€æ¬¡
2. âœ… æ‰€æœ‰APIæ–¹æ³•è‡ªåŠ¨æ”¯æŒç¼“å­˜
3. âœ… ä¸šåŠ¡ä»£ç ä¸ç¼“å­˜è§£è€¦
4. âœ… ä¿®æ”¹ç¼“å­˜ç­–ç•¥åªéœ€æ”¹ä¸€å¤„
5. âœ… æ–°å¢APIæ— éœ€é¢å¤–ä»£ç 

**ç±»æ¯”åç«¯ç†è§£ï¼š**
è¿™å°±åƒSpringçš„`@Cacheable`æ³¨è§£ï¼š
```java
// ä¸ç”¨è¿™æ ·æ‰‹åŠ¨ç¼“å­˜
public User getUser(Long id) {
    String key = "user:" + id;
    User cached = redis.get(key);
    if (cached != null) return cached;

    User user = userMapper.selectById(id);
    redis.set(key, user);
    return user;
}

// åªéœ€è¦åŠ æ³¨è§£
@Cacheable(value = "user", key = "#id")
public User getUser(Long id) {
    return userMapper.selectById(id);
}
```

---

### åœºæ™¯4ï¸âƒ£ï¼šæƒé™æ§åˆ¶

#### âŒ ä¸ä½¿ç”¨ä»£ç†çš„ä¼ ç»Ÿæ–¹å¼

```javascript
// ä¼ ç»Ÿæ–¹å¼ï¼šåœ¨æ¯ä¸ªæ“ä½œé‡Œæ£€æŸ¥æƒé™
class EmployeeManager {
  constructor(currentUser) {
    this.currentUser = currentUser;
    this.employee = {
      id: 1001,
      name: 'å¼ ä¸‰',
      salary: 50000,
      ssn: '123456'
    };
  }

  // é—®é¢˜ï¼šæ¯ä¸ªæ–¹æ³•éƒ½è¦å†™æƒé™æ£€æŸ¥
  viewSalary() {
    // æ‰‹åŠ¨æƒé™æ£€æŸ¥
    if (this.currentUser.role !== 'admin' &&
        this.currentUser.role !== 'manager') {
      throw new Error('æ— æƒæŸ¥çœ‹è–ªèµ„');
    }
    return this.employee.salary;
  }

  updateSalary(newSalary) {
    // åˆæ˜¯æ‰‹åŠ¨æƒé™æ£€æŸ¥
    if (this.currentUser.role !== 'admin' &&
        this.currentUser.role !== 'manager') {
      throw new Error('æ— æƒä¿®æ”¹è–ªèµ„');
    }
    this.employee.salary = newSalary;
  }

  viewSSN() {
    // è¿˜æ˜¯æ‰‹åŠ¨æƒé™æ£€æŸ¥
    if (this.currentUser.role !== 'admin') {
      throw new Error('æ— æƒæŸ¥çœ‹èº«ä»½è¯');
    }
    return this.employee.ssn;
  }

  updateName(newName) {
    // æ¯ä¸ªæ–¹æ³•éƒ½è¦é‡å¤è¿™ä¸ªæ¨¡å¼
    if (this.currentUser.role === 'employee') {
      throw new Error('æ™®é€šå‘˜å·¥æ— æƒä¿®æ”¹å§“å');
    }
    this.employee.name = newName;
  }

  // æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™æƒé™æ£€æŸ¥...
}

// ä½¿ç”¨æ—¶å¾ˆç¹ç
const manager = new EmployeeManager({ role: 'employee' });
try {
  manager.viewSalary(); // æŠ›å‡ºé”™è¯¯
} catch (e) {
  console.log(e.message);
}
```

**é—®é¢˜æ€»ç»“ï¼š**
1. âŒ æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™æƒé™æ£€æŸ¥
2. âŒ æƒé™é€»è¾‘åˆ†æ•£
3. âŒ éš¾ä»¥ç»Ÿä¸€ä¿®æ”¹æƒé™è§„åˆ™
4. âŒ å®¹æ˜“é—æ¼æƒé™æ£€æŸ¥
5. âŒ æ–°å¢å­—æ®µæˆ–æ–¹æ³•æ—¶å®¹æ˜“å‡ºé”™

---

#### âœ… ä½¿ç”¨ä»£ç†çš„ç»Ÿä¸€æƒé™æ§åˆ¶

```javascript
// ä½¿ç”¨Proxyï¼šè‡ªåŠ¨æ‹¦æˆªæ‰€æœ‰è®¿é—®ï¼Œç»Ÿä¸€æƒé™æ£€æŸ¥
class EmployeeManager {
  constructor(employee, currentUser) {
    // æƒé™é…ç½®ï¼ˆé›†ä¸­ç®¡ç†ï¼‰
    this.permissions = {
      read: {
        admin: ['id', 'name', 'salary', 'ssn'],
        manager: ['id', 'name', 'salary'],
        employee: ['id', 'name']
      },
      write: {
        admin: ['name', 'salary', 'ssn'],
        manager: ['name', 'salary'],
        employee: []
      }
    };

    // è¿”å›ä»£ç†å¯¹è±¡
    return new Proxy(employee, {
      get: (target, property) => {
        // ç»Ÿä¸€çš„è¯»æƒé™æ£€æŸ¥
        const allowedFields = this.permissions.read[currentUser.role];
        if (!allowedFields.includes(property)) {
          console.log(`âŒ ${currentUser.role} æ— æƒè¯»å– ${property}`);
          throw new Error(`æ— æƒè¯»å– ${property}`);
        }

        console.log(`âœ… ${currentUser.role} è¯»å– ${property}: ${target[property]}`);
        return target[property];
      },

      set: (target, property, value) => {
        // ç»Ÿä¸€çš„å†™æƒé™æ£€æŸ¥
        const allowedFields = this.permissions.write[currentUser.role];
        if (!allowedFields.includes(property)) {
          console.log(`âŒ ${currentUser.role} æ— æƒä¿®æ”¹ ${property}`);
          throw new Error(`æ— æƒä¿®æ”¹ ${property}`);
        }

        console.log(`âœ… ${currentUser.role} ä¿®æ”¹ ${property}: ${target[property]} â†’ ${value}`);
        target[property] = value;
        return true;
      }
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const employee = {
  id: 1001,
  name: 'å¼ ä¸‰',
  salary: 50000,
  ssn: '123456'
};

// æ™®é€šå‘˜å·¥
const empProxy = new EmployeeManager(employee, { role: 'employee' });
console.log(empProxy.name);    // âœ… å¯ä»¥è¯»å–
// console.log(empProxy.salary); // âŒ æŠ›å‡ºé”™è¯¯ï¼šæ— æƒè¯»å–salary
// empProxy.name = 'æå››';       // âŒ æŠ›å‡ºé”™è¯¯ï¼šæ— æƒä¿®æ”¹name

// ç»ç†
const mgrProxy = new EmployeeManager(employee, { role: 'manager' });
console.log(mgrProxy.salary);  // âœ… å¯ä»¥è¯»å–
mgrProxy.salary = 60000;       // âœ… å¯ä»¥ä¿®æ”¹
// console.log(mgrProxy.ssn);   // âŒ æŠ›å‡ºé”™è¯¯ï¼šæ— æƒè¯»å–ssn

// ç®¡ç†å‘˜
const adminProxy = new EmployeeManager(employee, { role: 'admin' });
console.log(adminProxy.ssn);   // âœ… å¯ä»¥è¯»å–
adminProxy.ssn = '654321';     // âœ… å¯ä»¥ä¿®æ”¹
```

**ä¼˜åŠ¿æ€»ç»“ï¼š**
1. âœ… æƒé™é€»è¾‘é›†ä¸­åœ¨é…ç½®å¯¹è±¡ä¸­
2. âœ… è‡ªåŠ¨æ‹¦æˆªæ‰€æœ‰å±æ€§è®¿é—®
3. âœ… ä¸ä¼šé—æ¼æƒé™æ£€æŸ¥
4. âœ… ä¿®æ”¹æƒé™è§„åˆ™åªéœ€æ”¹é…ç½®
5. âœ… æ–°å¢å­—æ®µè‡ªåŠ¨ç»§æ‰¿æƒé™æ§åˆ¶

**ç±»æ¯”åç«¯ç†è§£ï¼š**
è¿™å°±åƒSpring Securityçš„æ–¹æ³•çº§æƒé™æ§åˆ¶ï¼š
```java
// ä¸ç”¨åœ¨æ¯ä¸ªæ–¹æ³•é‡Œæ‰‹åŠ¨æ£€æŸ¥
public BigDecimal getSalary() {
    if (!hasRole("ADMIN", "MANAGER")) {
        throw new AccessDeniedException();
    }
    return employee.getSalary();
}

// åªéœ€è¦åŠ æ³¨è§£
@PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
public BigDecimal getSalary() {
    return employee.getSalary();
}
```

---

## åç«¯åœºæ™¯å¯¹æ¯”

### åœºæ™¯5ï¸âƒ£ï¼šäº‹åŠ¡ç®¡ç†ï¼ˆä½ çš„UserServiceProxyç¤ºä¾‹ï¼‰

#### âŒ ä¸ä½¿ç”¨ä»£ç†

```java
// æ¯ä¸ªServiceæ–¹æ³•éƒ½è¦æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡
public class UserServiceImpl implements UserService {
    private UserMapper userMapper;

    @Override
    public void save() {
        Connection conn = null;
        try {
            // æ‰‹åŠ¨å¼€å¯äº‹åŠ¡
            conn = ConnectionUtils.getConnection();
            conn.beginTransaction();

            // ä¸šåŠ¡é€»è¾‘
            log.info("UserServiceImpl --- save");
            userMapper.save();

            // æ‰‹åŠ¨æäº¤äº‹åŠ¡
            conn.commit();
        } catch (Exception e) {
            // æ‰‹åŠ¨å›æ»šäº‹åŠ¡
            if (conn != null) {
                conn.rollback();
            }
            throw e;
        }
    }

    @Override
    public void update() {
        Connection conn = null;
        try {
            // åˆè¦é‡å¤ä¸€éäº‹åŠ¡ä»£ç 
            conn = ConnectionUtils.getConnection();
            conn.beginTransaction();

            log.info("UserServiceImpl --- update");
            userMapper.update();

            conn.commit();
        } catch (Exception e) {
            if (conn != null) {
                conn.rollback();
            }
            throw e;
        }
    }

    // æ¯ä¸ªæ–¹æ³•éƒ½è¦é‡å¤è¿™ä¸ªæ¨¡å¼...
}
```

**é—®é¢˜ï¼š**
- âŒ æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™äº‹åŠ¡ä»£ç 
- âŒ ä¸šåŠ¡é€»è¾‘å’Œäº‹åŠ¡é€»è¾‘è€¦åˆ
- âŒ ä»£ç é‡å¤ï¼Œå®¹æ˜“å‡ºé”™

---

#### âœ… ä½¿ç”¨é™æ€ä»£ç†ï¼ˆä½ çš„ä»£ç ï¼‰

```java
@Slf4j
public class UserServiceProxy implements UserService {
    private UserService userService;

    public UserServiceProxy(UserService userService) {
        this.userService = userService;
    }

    @Override
    public void save() {
        // ç»Ÿä¸€çš„äº‹åŠ¡å¤„ç†
        ConnectionUtils.Connection conn = ConnectionUtils.getConnection();
        conn.beginTransaction();
        userService.save();  // åªå…³æ³¨ä¸šåŠ¡é€»è¾‘
        conn.commit();
    }
}

// åŸå§‹Serviceåªéœ€å…³æ³¨ä¸šåŠ¡
public class UserServiceImpl implements UserService {
    private UserMapper userMapper;

    @Override
    public void save() {
        log.info("UserServiceImpl --- save");
        userMapper.save();  // çº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘
    }
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… äº‹åŠ¡é€»è¾‘é›†ä¸­åœ¨ä»£ç†ç±»
- âœ… ä¸šåŠ¡é€»è¾‘ä¸äº‹åŠ¡è§£è€¦
- âœ… ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

---

### åœºæ™¯6ï¸âƒ£ï¼šæ¥å£å®ç°ï¼ˆä½ çš„MapperProxyç¤ºä¾‹ï¼‰

#### âŒ ä¸ä½¿ç”¨ä»£ç†

```java
// éœ€è¦ä¸ºæ¯ä¸ªMapperæ‰‹åŠ¨å†™å®ç°ç±»
public class UserMapperImpl implements UserMapper {
    @Override
    public void save() {
        // æ‰‹åŠ¨è§£ææ³¨è§£
        Method method = this.getClass().getMethod("save");
        Insert annotation = method.getAnnotation(Insert.class);
        String sql = annotation.value();

        // æ‰‹åŠ¨è·å–è¿æ¥
        Connection conn = ConnectionUtils.getConnection();

        // æ‰‹åŠ¨æ‰§è¡ŒSQL
        log.info("æ‰§è¡Œè¯­å¥ï¼š{}", sql);
        // JDBCä»£ç ...
    }
}

public class OrderMapperImpl implements OrderMapper {
    @Override
    public void insert() {
        // åˆè¦é‡å¤ç›¸åŒçš„é€»è¾‘
        Method method = this.getClass().getMethod("insert");
        Insert annotation = method.getAnnotation(Insert.class);
        // ...
    }
}

// æ¯ä¸ªMapperéƒ½è¦å†™å®ç°ç±»...
```

**é—®é¢˜ï¼š**
- âŒ æ¯ä¸ªMapperéƒ½è¦æ‰‹å†™å®ç°
- âŒ å¤§é‡é‡å¤ä»£ç 
- âŒ ç»´æŠ¤æˆæœ¬é«˜

---

#### âœ… ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼ˆä½ çš„ä»£ç ï¼‰

```java
public class MapperJDKInvocationHandler implements InvocationHandler {
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) {
        // ç»Ÿä¸€å¤„ç†æ‰€æœ‰Mapperæ–¹æ³•
        ConnectionUtils.Connection conn = ConnectionUtils.getConnection();
        Object insertSql = AnnotationUtil.getAnnotationValue(method, Insert.class);
        log.info("æ‰§è¡Œè¯­å¥ï¼š{}", insertSql);
        return null;
    }
}

// ä½¿ç”¨
UserMapper mapper = (UserMapper) Proxy.newProxyInstance(
    UserMapper.class.getClassLoader(),
    new Class[]{UserMapper.class},
    new MapperJDKInvocationHandler()
);
mapper.save(); // è‡ªåŠ¨æ‰§è¡Œä»£ç†é€»è¾‘

// æ–°å¢Mapperæ— éœ€å†™å®ç°ç±»
OrderMapper orderMapper = (OrderMapper) Proxy.newProxyInstance(
    OrderMapper.class.getClassLoader(),
    new Class[]{OrderMapper.class},
    new MapperJDKInvocationHandler()
);
orderMapper.insert(); // è‡ªåŠ¨æ”¯æŒ
```

**ä¼˜åŠ¿ï¼š**
- âœ… ä¸€ä¸ªHandlerå¤„ç†æ‰€æœ‰Mapper
- âœ… æ–°å¢Mapperæ— éœ€å†™å®ç°
- âœ… è¿™å°±æ˜¯MyBatisçš„æ ¸å¿ƒåŸç†

---

## å®é™…ä»·å€¼åˆ†æ

### ğŸ’° å¼€å‘æ•ˆç‡æå‡

| åœºæ™¯ | ä¸ä½¿ç”¨ä»£ç† | ä½¿ç”¨ä»£ç† | èŠ‚çœä»£ç é‡ |
|-----|----------|---------|-----------|
| è¡¨å•éªŒè¯ | æ¯ä¸ªå­—æ®µå†™setter | é…ç½®éªŒè¯è§„åˆ™ | 70% |
| å“åº”å¼æ•°æ® | æ‰‹åŠ¨æ›´æ–°UI | è‡ªåŠ¨æ›´æ–° | 80% |
| APIç¼“å­˜ | æ¯ä¸ªæ–¹æ³•å†™ç¼“å­˜ | ç»Ÿä¸€ä»£ç† | 90% |
| æƒé™æ§åˆ¶ | æ¯ä¸ªæ–¹æ³•æ£€æŸ¥ | é…ç½®æƒé™è¡¨ | 85% |
| äº‹åŠ¡ç®¡ç† | æ¯ä¸ªæ–¹æ³•try-catch | ä»£ç†ç»Ÿä¸€å¤„ç† | 75% |

### ğŸ›¡ï¸ ä»£ç è´¨é‡æå‡

**ä¸ä½¿ç”¨ä»£ç†çš„é—®é¢˜ï¼š**
1. âŒ ä»£ç é‡å¤ï¼ˆDRYåŸåˆ™ï¼‰
2. âŒ å…³æ³¨ç‚¹åˆ†æ•£ï¼ˆSRPåŸåˆ™ï¼‰
3. âŒ éš¾ä»¥ç»´æŠ¤
4. âŒ å®¹æ˜“å‡ºé”™
5. âŒ æ‰©å±•æ€§å·®

**ä½¿ç”¨ä»£ç†çš„ä¼˜åŠ¿ï¼š**
1. âœ… ä»£ç å¤ç”¨
2. âœ… å…³æ³¨ç‚¹åˆ†ç¦»
3. âœ… æ˜“äºç»´æŠ¤
4. âœ… å‡å°‘é”™è¯¯
5. âœ… é«˜æ‰©å±•æ€§

### ğŸ¯ é€‚ç”¨åœºæ™¯åˆ¤æ–­

**é€‚åˆä½¿ç”¨ä»£ç†ï¼š**
- âœ… æœ‰é‡å¤çš„æ¨ªåˆ‡é€»è¾‘ï¼ˆéªŒè¯ã€æ—¥å¿—ã€ç¼“å­˜ã€æƒé™ï¼‰
- âœ… éœ€è¦åŠ¨æ€å¢å¼ºåŠŸèƒ½
- âœ… éœ€è¦å»¶è¿ŸåŠ è½½
- âœ… éœ€è¦è®¿é—®æ§åˆ¶

**ä¸é€‚åˆä½¿ç”¨ä»£ç†ï¼š**
- âŒ ç®€å•çš„ä¸€æ¬¡æ€§æ“ä½œ
- âŒ æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
- âŒ é€»è¾‘éå¸¸ç‰¹æ®Šï¼Œæ— æ³•ç»Ÿä¸€å¤„ç†

---

## æ€»ç»“ï¼šä¸ºä»€ä¹ˆå‰ç«¯éœ€è¦ä»£ç†æ¨¡å¼ï¼Ÿ

### å‰ç«¯çš„ç‰¹æ®Šæ€§

1. **ç”¨æˆ·äº¤äº’é¢‘ç¹**
   - æ¯æ¬¡è¾“å…¥éƒ½å¯èƒ½è§¦å‘éªŒè¯
   - ä»£ç†è‡ªåŠ¨å¤„ç†ï¼Œä¸ä¼šé—æ¼

2. **çŠ¶æ€ç®¡ç†å¤æ‚**
   - æ•°æ®å˜åŒ–è¦æ›´æ–°å¤šå¤„UI
   - ä»£ç†è‡ªåŠ¨è¿½è¸ªä¾èµ–å…³ç³»

3. **æ€§èƒ½ä¼˜åŒ–éœ€æ±‚**
   - å›¾ç‰‡æ‡’åŠ è½½èŠ‚çœæµé‡
   - APIç¼“å­˜å‡å°‘è¯·æ±‚

4. **å®‰å…¨æ€§è¦æ±‚**
   - æ•æ„Ÿæ•°æ®è®¿é—®æ§åˆ¶
   - ä»£ç†ç»Ÿä¸€æ‹¦æˆª

### ä¸åç«¯çš„å¯¹æ¯”

| ç»´åº¦ | åç«¯ | å‰ç«¯ |
|-----|------|------|
| ä»£ç†ç›®çš„ | äº‹åŠ¡ã€æƒé™ã€æ—¥å¿— | éªŒè¯ã€å“åº”å¼ã€ç¼“å­˜ |
| å®ç°æ–¹å¼ | JDK Proxyã€CGLIB | ES6 Proxy |
| å…¸å‹æ¡†æ¶ | Spring AOPã€MyBatis | Vue3ã€MobX |
| ä¸»è¦ä»·å€¼ | è§£è€¦ä¸šåŠ¡å’ŒåŸºç¡€è®¾æ–½ | è‡ªåŠ¨åŒ–UIæ›´æ–°å’Œæ•°æ®å¤„ç† |

**ç»“è®ºï¼šä»£ç†æ¨¡å¼æ˜¯å‰åç«¯éƒ½æå…¶é‡è¦çš„è®¾è®¡æ¨¡å¼ï¼Œæ ¸å¿ƒæ€æƒ³ç›¸åŒï¼Œä½†åº”ç”¨åœºæ™¯æœ‰æ‰€ä¸åŒã€‚**
