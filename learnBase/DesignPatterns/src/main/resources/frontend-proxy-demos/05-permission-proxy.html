<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo 5: æƒé™æ§åˆ¶ä»£ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #12c2e9 0%, #c471ed 50%, #f64f59 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 10px;
      font-size: 36px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.95);
      text-align: center;
      margin-bottom: 30px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .panel {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .panel h2 {
      color: #c471ed;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 2px solid #c471ed;
      padding-bottom: 10px;
    }

    .user-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 25px;
    }

    .user-btn {
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .user-btn:hover {
      border-color: #c471ed;
      transform: translateY(-2px);
    }

    .user-btn.active {
      background: linear-gradient(135deg, #c471ed 0%, #f64f59 100%);
      color: white;
      border-color: transparent;
    }

    .user-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .user-role {
      font-size: 12px;
      color: #666;
    }

    .user-btn.active .user-role {
      color: rgba(255, 255, 255, 0.9);
    }

    .data-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .data-card {
      background: #f5f7fa;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .data-card.locked {
      background: #ffebee;
      border-color: #f44336;
      position: relative;
    }

    .data-card.locked::before {
      content: 'ğŸ”’';
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
    }

    .data-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .data-value {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    .data-card.locked .data-value {
      filter: blur(5px);
      user-select: none;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .action-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .action-btn.read {
      background: #2196f3;
      color: white;
    }

    .action-btn.write {
      background: #4caf50;
      color: white;
    }

    .action-btn.delete {
      background: #f44336;
      color: white;
    }

    .action-btn:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }

    .action-btn:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .log-panel {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 20px;
      height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }

    .log-entry {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
      border-left: 3px solid transparent;
    }

    .log-success {
      background: rgba(76, 175, 80, 0.1);
      border-left-color: #4caf50;
      color: #4caf50;
    }

    .log-error {
      background: rgba(244, 67, 54, 0.1);
      border-left-color: #f44336;
      color: #f44336;
    }

    .log-warning {
      background: rgba(255, 152, 0, 0.1);
      border-left-color: #ff9800;
      color: #ff9800;
    }

    .log-info {
      background: rgba(33, 150, 243, 0.1);
      border-left-color: #2196f3;
      color: #2196f3;
    }

    .permissions-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .permissions-table th,
    .permissions-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .permissions-table th {
      background: #f5f7fa;
      font-weight: 600;
      color: #666;
      font-size: 12px;
    }

    .permissions-table td {
      font-size: 13px;
    }

    .permission-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
    }

    .permission-indicator.allowed {
      background: #4caf50;
      color: white;
    }

    .permission-indicator.denied {
      background: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>æƒé™æ§åˆ¶ä»£ç†</h1>
    <p class="subtitle">ä½¿ç”¨Proxyå®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰</p>

    <div class="layout">
      <!-- å·¦ä¾§ï¼šç”¨æˆ·åˆ‡æ¢å’Œæ•°æ®æ˜¾ç¤º -->
      <div class="panel">
        <h2>é€‰æ‹©ç”¨æˆ·è§’è‰²</h2>

        <div class="user-selector">
          <div class="user-btn active" onclick="switchUser('employee', this)">
            <div class="user-icon">ğŸ‘¤</div>
            <div>æ™®é€šå‘˜å·¥</div>
            <div class="user-role">Employee</div>
          </div>
          <div class="user-btn" onclick="switchUser('manager', this)">
            <div class="user-icon">ğŸ‘”</div>
            <div>éƒ¨é—¨ç»ç†</div>
            <div class="user-role">Manager</div>
          </div>
          <div class="user-btn" onclick="switchUser('admin', this)">
            <div class="user-icon">ğŸ‘‘</div>
            <div>ç³»ç»Ÿç®¡ç†å‘˜</div>
            <div class="user-role">Admin</div>
          </div>
        </div>

        <h2>å‘˜å·¥æ•°æ®</h2>
        <div class="data-grid">
          <div class="data-card" id="card-id">
            <div class="data-label">å‘˜å·¥ID</div>
            <div class="data-value" id="value-id">EMP-1001</div>
          </div>
          <div class="data-card" id="card-name">
            <div class="data-label">å§“å</div>
            <div class="data-value" id="value-name">å¼ ä¸‰</div>
          </div>
          <div class="data-card" id="card-email">
            <div class="data-label">é‚®ç®±</div>
            <div class="data-value" id="value-email">zhangsan@company.com</div>
          </div>
          <div class="data-card" id="card-salary">
            <div class="data-label">è–ªèµ„</div>
            <div class="data-value" id="value-salary">Â¥50,000</div>
          </div>
          <div class="data-card" id="card-ssn">
            <div class="data-label">èº«ä»½è¯å·</div>
            <div class="data-value" id="value-ssn">110101199001011234</div>
          </div>
          <div class="data-card" id="card-bankAccount">
            <div class="data-label">é“¶è¡Œè´¦å·</div>
            <div class="data-value" id="value-bankAccount">6222 **** **** 1234</div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="action-btn read" onclick="tryReadSalary()">è¯»å–è–ªèµ„</button>
          <button class="action-btn write" onclick="tryUpdateEmail()">ä¿®æ”¹é‚®ç®±</button>
          <button class="action-btn write" onclick="tryUpdateSalary()">ä¿®æ”¹è–ªèµ„</button>
          <button class="action-btn delete" onclick="tryDeleteSSN()">åˆ é™¤èº«ä»½è¯</button>
        </div>

        <h2 style="margin-top: 25px;">æƒé™çŸ©é˜µ</h2>
        <table class="permissions-table">
          <thead>
            <tr>
              <th>å­—æ®µ</th>
              <th>è¯»å–</th>
              <th>ä¿®æ”¹</th>
              <th>åˆ é™¤</th>
            </tr>
          </thead>
          <tbody id="permissionsTable"></tbody>
        </table>
      </div>

      <!-- å³ä¾§ï¼šæ—¥å¿— -->
      <div class="panel">
        <h2>æ“ä½œæ—¥å¿—</h2>
        <div class="log-panel" id="logPanel"></div>
      </div>
    </div>
  </div>

  <script>
    // ============ æƒé™æ§åˆ¶ä»£ç†å®ç° ============

    class PermissionProxy {
      constructor(target, currentUser) {
        this.target = target;
        this.currentUser = currentUser;

        return new Proxy(target, {
          get: (target, property) => {
            if (!this.hasReadPermission(property)) {
              this.log(`âŒ è®¿é—®è¢«æ‹’ç»: ${this.currentUser.name} å°è¯•è¯»å– ${property}`, 'error');
              throw new Error(`Access denied: Cannot read property '${property}'`);
            }
            this.log(`âœ… è¯»å–æˆåŠŸ: ${this.currentUser.name} è¯»å– ${property} = ${target[property]}`, 'success');
            return target[property];
          },
          set: (target, property, value) => {
            if (!this.hasWritePermission(property)) {
              this.log(`âŒ ä¿®æ”¹è¢«æ‹’ç»: ${this.currentUser.name} å°è¯•ä¿®æ”¹ ${property}`, 'error');
              throw new Error(`Access denied: Cannot write property '${property}'`);
            }
            const oldValue = target[property];
            target[property] = value;
            this.log(`âœ… ä¿®æ”¹æˆåŠŸ: ${this.currentUser.name} ä¿®æ”¹ ${property}: ${oldValue} â†’ ${value}`, 'success');
            this.updateUI();
            return true;
          },
          deleteProperty: (target, property) => {
            if (!this.hasDeletePermission(property)) {
              this.log(`âŒ åˆ é™¤è¢«æ‹’ç»: ${this.currentUser.name} å°è¯•åˆ é™¤ ${property}`, 'error');
              throw new Error(`Access denied: Cannot delete property '${property}'`);
            }
            delete target[property];
            this.log(`âœ… åˆ é™¤æˆåŠŸ: ${this.currentUser.name} åˆ é™¤ ${property}`, 'warning');
            this.updateUI();
            return true;
          }
        });
      }

      hasReadPermission(property) {
        const permissions = {
          admin: ['id', 'name', 'email', 'salary', 'ssn', 'bankAccount'],
          manager: ['id', 'name', 'email', 'salary'],
          employee: ['id', 'name', 'email']
        };
        return permissions[this.currentUser.role]?.includes(property);
      }

      hasWritePermission(property) {
        const permissions = {
          admin: ['name', 'email', 'salary', 'ssn', 'bankAccount'],
          manager: ['name', 'email', 'salary'],
          employee: ['email']
        };
        return permissions[this.currentUser.role]?.includes(property);
      }

      hasDeletePermission(property) {
        // åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æ•æ„Ÿä¿¡æ¯
        return this.currentUser.role === 'admin';
      }

      log(message, type = 'info') {
        const logPanel = document.getElementById('logPanel');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        logPanel.insertBefore(entry, logPanel.firstChild);
      }

      updateUI() {
        updateDataDisplay();
      }
    }

    // ============ åº”ç”¨ç¤ºä¾‹ ============

    const employeeData = {
      id: 'EMP-1001',
      name: 'å¼ ä¸‰',
      email: 'zhangsan@company.com',
      salary: 50000,
      ssn: '110101199001011234',
      bankAccount: '6222 **** **** 1234'
    };

    let currentUser = { name: 'Jane', role: 'employee' };
    let employeeProxy = new PermissionProxy(employeeData, currentUser);

    // æ›´æ–°æ•°æ®æ˜¾ç¤º
    function updateDataDisplay() {
      const fields = ['id', 'name', 'email', 'salary', 'ssn', 'bankAccount'];

      fields.forEach(field => {
        const card = document.getElementById(`card-${field}`);
        const value = document.getElementById(`value-${field}`);

        try {
          // å°è¯•è¯»å–ï¼ˆä¼šè§¦å‘æƒé™æ£€æŸ¥ï¼‰
          const data = employeeProxy[field];
          value.textContent = field === 'salary' ? `Â¥${data.toLocaleString()}` : data;
          card.classList.remove('locked');
        } catch (error) {
          // æ— æƒé™è®¿é—®
          card.classList.add('locked');
        }
      });

      updatePermissionsTable();
    }

    // æ›´æ–°æƒé™è¡¨
    function updatePermissionsTable() {
      const fields = ['id', 'name', 'email', 'salary', 'ssn', 'bankAccount'];
      const tbody = document.getElementById('permissionsTable');
      tbody.innerHTML = '';

      fields.forEach(field => {
        const canRead = employeeProxy.hasReadPermission(field);
        const canWrite = employeeProxy.hasWritePermission(field);
        const canDelete = employeeProxy.hasDeletePermission(field);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${field}</strong></td>
          <td><span class="permission-indicator ${canRead ? 'allowed' : 'denied'}">${canRead ? 'âœ“' : 'âœ—'}</span></td>
          <td><span class="permission-indicator ${canWrite ? 'allowed' : 'denied'}">${canWrite ? 'âœ“' : 'âœ—'}</span></td>
          <td><span class="permission-indicator ${canDelete ? 'allowed' : 'denied'}">${canDelete ? 'âœ“' : 'âœ—'}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    // åˆ‡æ¢ç”¨æˆ·
    function switchUser(role, element) {
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.user-btn').forEach(btn => btn.classList.remove('active'));
      element.classList.add('active');

      // åˆ‡æ¢ç”¨æˆ·
      const userNames = { employee: 'Jane', manager: 'Mike', admin: 'Admin' };
      currentUser = { name: userNames[role], role: role };
      employeeProxy = new PermissionProxy(employeeData, currentUser);

      employeeProxy.log(`ğŸ”„ åˆ‡æ¢ç”¨æˆ·: ${currentUser.name} (${role})`, 'info');
      updateDataDisplay();
    }

    // æµ‹è¯•æ“ä½œ
    function tryReadSalary() {
      try {
        const salary = employeeProxy.salary;
        alert(`è–ªèµ„: Â¥${salary.toLocaleString()}`);
      } catch (error) {
        alert('âŒ ' + error.message);
      }
    }

    function tryUpdateEmail() {
      const newEmail = prompt('è¯·è¾“å…¥æ–°é‚®ç®±:');
      if (newEmail) {
        try {
          employeeProxy.email = newEmail;
          alert('âœ… é‚®ç®±ä¿®æ”¹æˆåŠŸï¼');
        } catch (error) {
          alert('âŒ ' + error.message);
        }
      }
    }

    function tryUpdateSalary() {
      const newSalary = prompt('è¯·è¾“å…¥æ–°è–ªèµ„:');
      if (newSalary) {
        try {
          employeeProxy.salary = Number(newSalary);
          alert('âœ… è–ªèµ„ä¿®æ”¹æˆåŠŸï¼');
        } catch (error) {
          alert('âŒ ' + error.message);
        }
      }
    }

    function tryDeleteSSN() {
      if (confirm('ç¡®å®šè¦åˆ é™¤èº«ä»½è¯ä¿¡æ¯å—ï¼Ÿ')) {
        try {
          delete employeeProxy.ssn;
          alert('âœ… èº«ä»½è¯ä¿¡æ¯å·²åˆ é™¤ï¼');
        } catch (error) {
          alert('âŒ ' + error.message);
        }
      }
    }

    // åˆå§‹åŒ–
    employeeProxy.log('âœ¨ æƒé™æ§åˆ¶ç³»ç»Ÿå·²åˆå§‹åŒ–', 'success');
    employeeProxy.log('ğŸ’¡ å°è¯•åˆ‡æ¢ä¸åŒè§’è‰²ï¼Œä½“éªŒæƒé™æ§åˆ¶', 'info');
    updateDataDisplay();
  </script>
</body>
</html>
